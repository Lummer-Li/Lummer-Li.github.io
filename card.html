<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Academic Stats Card</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #165DFF;
            --primary-light: #E8F3FF;
            --primary-dark: #0E42D2;
            --text-primary: #1D2129;
            --text-secondary: #4E5969;
            --text-tertiary: #86909C;
            --bg-white: #FFFFFF;
            --bg-gray: #F5F7FA;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-gray);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
            min-height: 100vh;
        }

        /* 移除搜索框，保留状态提示和卡片样式 */
        .stats-card {
            background-color: var(--bg-white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: var(--spacing-lg);
            width: 100%;
            max-width: 520px;
            display: flex;
            gap: var(--spacing-lg);
            position: relative;
            overflow: hidden;
            display: none; /* 初始隐藏，获取数据后显示 */
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--primary-dark));
        }

        .stats-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary-light);
            object-fit: cover;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card-title {
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title i {
            font-size: 1.3rem;
        }

        .user-link {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-decoration: none;
            margin-top: 2px;
            transition: color 0.2s ease;
        }

        .user-link:hover {
            color: var(--primary);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .stats-list {
            list-style: none;
        }

        .stats-item {
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 4px 0;
        }

        .stats-icon {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.05rem;
            background-color: var(--primary-light);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .stats-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            flex: 1;
            letter-spacing: 0.02em;
        }

        .stats-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.95rem;
            min-width: 40px;
            text-align: right;
        }

        .rank-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 105px;
            padding: var(--spacing-sm) 0;
        }

        .rank-circle {
            width: 88px;
            height: 88px;
            position: relative;
            margin-bottom: var(--spacing-sm);
        }

        .circle-bg {
            fill: none;
            stroke: var(--primary-light);
            stroke-width: 9;
        }

        .circle-progress {
            fill: none;
            stroke: var(--primary);
            stroke-width: 9;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rank-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .rank-label {
            color: var(--text-tertiary);
            font-size: 0.82rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-message {
            font-size: 0.95rem;
            color: var(--text-tertiary);
            text-align: center;
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 520px;
            border-radius: 8px;
            background-color: var(--bg-white);
            box-shadow: var(--shadow);
        }

        .error-message {
            color: #DC3545;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .error-message i {
            font-size: 1.1rem;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-card {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .stats-item {
            opacity: 0;
            animation: fadeInUp 0.35s ease-out forwards;
            animation-delay: calc(var(--item-index) * 0.08s);
        }

        .rank-circle {
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            animation-delay: 0.4s;
        }

        @media (max-width: 480px) {
            .stats-card {
                flex-direction: column;
                padding: var(--spacing-md);
                gap: var(--spacing-md);
            }

            .stats-header {
                margin-bottom: var(--spacing-sm);
            }

            .card-title {
                font-size: 1.15rem;
            }

            .rank-section {
                flex-direction: row;
                gap: var(--spacing-md);
                justify-content: flex-start;
                min-width: auto;
                margin-top: var(--spacing-sm);
                padding: var(--spacing-sm) var(--spacing-sm) 0;
            }

            .rank-circle {
                width: 76px;
                height: 76px;
                margin-bottom: 0;
            }

            .rank-text {
                font-size: 1.8rem;
            }
        }

        @media (max-width: 360px) {
            .stats-label {
                font-size: 0.85rem;
            }

            .stats-value {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载状态提示 -->
    <div id="loading" class="status-message">
        <i class="fa-solid fa-spinner fa-spin"></i> 正在加载数据...
    </div>

    <!-- 错误提示（无参数/请求失败时显示） -->
    <div id="error" class="status-message error-message" style="display: none;"></div>

    <!-- 卡片主体（默认隐藏） -->
    <div class="stats-card" id="stats-card">
        <div class="stats-content">
            <div class="stats-header">
                <img 
                    class="avatar" 
                    id="user-avatar" 
                    src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" 
                    alt="User Avatar"
                >
                <div class="header-content">
                    <h2 class="card-title">
                        <i class="fa-brands fa-github"></i>
                        GitHub Stats
                    </h2>
                    <a href="" class="user-link" id="user-url" target="_blank"></a>
                </div>
            </div>
            <ul class="stats-list">
                <li class="stats-item" style="--item-index: 1">
                    <div class="stats-icon"><i class="fa-solid fa-star"></i></div>
                    <span class="stats-label">Total Stars Earned</span>
                    <span class="stats-value" id="stars-count">--</span>
                </li>
                <li class="stats-item" style="--item-index: 2">
                    <div class="stats-icon"><i class="fa-solid fa-code"></i></div>
                    <span class="stats-label">Commits (@year)</span>
                    <span class="stats-value" id="commits-count">--</span>
                </li>
                <li class="stats-item" style="--item-index: 3">
                    <div class="stats-icon"><i class="fa-solid fa-code-fork"></i></div>
                    <span class="stats-label">Total Pull Requests</span>
                    <span class="stats-value" id="prs-count">--</span>
                </li>
                <li class="stats-item" style="--item-index: 4">
                    <div class="stats-icon"><i class="fa-solid fa-bug"></i></div>
                    <span class="stats-label">Total Issues</span>
                    <span class="stats-value" id="issues-count">--</span>
                </li>
                <li class="stats-item" style="--item-index: 5">
                    <div class="stats-icon"><i class="fa-solid fa-handshake-angle"></i></div>
                    <span class="stats-label">Contributed Repos (1y)</span>
                    <span class="stats-value" id="contrib-count">--</span>
                </li>
            </ul>
        </div>
        <div class="rank-section">
            <div class="rank-circle">
                <svg width="88" height="88" viewBox="0 0 100 100">
                    <circle class="circle-bg" cx="50" cy="50" r="41.5"></circle>
                    <circle class="circle-progress" id="rank-circle" cx="50" cy="50" r="41.5" 
                            stroke-dasharray="260.8" stroke-dashoffset="260.8"></circle>
                </svg>
                <div class="rank-text" id="rank-text">--</div>
            </div>
            <div class="rank-label">Academic Rank</div>
        </div>
    </div>

    <script>
        // DOM 元素
        const statsCard = document.getElementById('stats-card');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const rankCircle = document.getElementById('rank-circle');
        const rankText = document.getElementById('rank-text');
        const userAvatar = document.getElementById('user-avatar');
        const userUrl = document.getElementById('user-url');
        const commitsLabel = document.querySelector('.stats-item:nth-child(2) .stats-label');

        // 配置项
        const CORS_PROXY = 'https://fastly.jsdelivr.net/gh/iamowenke/proxy@main/proxy.php?url='; // 稳定代理
        const GITHUB_API_BASE = 'https://api.github.com';
        const CURRENT_YEAR = new Date().getFullYear();
        const CIRCUMFERENCE = 2 * Math.PI * 41.5;

        // 初始化年份标签
        commitsLabel.textContent = commitsLabel.textContent.replace('@year', CURRENT_YEAR);

        // 1. 解析URL中的username参数
        function getUsernameFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('username');
        }

        // 2. 请求超时处理（10秒）
        const fetchWithTimeout = async (url, options = {}, timeout = 10000) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (err) {
                clearTimeout(timeoutId);
                throw err;
            }
        };

        // 3. 拼接代理URL
        const getProxyUrl = (path) => `${CORS_PROXY}${encodeURIComponent(`${GITHUB_API_BASE}${path}`)}`;

        // 4. 获取用户基础信息
        async function fetchUserData(username) {
            const response = await fetchWithTimeout(getProxyUrl(`/users/${username}`));
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        // 5. 获取所有统计数据
        async function fetchAllStatsData(username) {
            const [reposData, commitsData, prsData, issuesData, contribData] = await Promise.all([
                fetchReposData(username),
                fetchYearlyCommits(username),
                fetchPullRequestsData(username),
                fetchIssuesData(username),
                fetchContributedRepos(username)
            ]);

            return {
                stars: reposData.totalStars,
                commits: commitsData,
                prs: prsData,
                issues: issuesData,
                contributions: contribData
            };
        }

        // 5.1 获取Stars总数
        async function fetchReposData(username) {
            const response = await fetchWithTimeout(getProxyUrl(`/users/${username}/repos?per_page=100`));
            if (!response.ok) throw new Error('仓库数据请求失败');
            const repos = await response.json();
            const totalStars = repos.reduce((sum, repo) => sum + repo.stargazers_count, 0);
            return { totalStars };
        }

        // 5.2 获取当年提交数（用events接口，更稳定）
        async function fetchYearlyCommits(username) {
            try {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const sinceDate = oneYearAgo.toISOString().split('T')[0];
                const response = await fetchWithTimeout(getProxyUrl(`/users/${username}/events?per_page=300&since=${sinceDate}`));
                if (!response.ok) throw new Error();
                const events = await response.json();
                let commitCount = 0;
                events.forEach(event => {
                    if (event.type === 'PushEvent' && new Date(event.created_at).getFullYear() === CURRENT_YEAR) {
                        commitCount += event.payload.commits?.length || 0;
                    }
                });
                return commitCount;
            } catch (err) {
                return 0; // 失败时返回0，避免卡片崩溃
            }
        }

        // 5.3 获取PR总数
        async function fetchPullRequestsData(username) {
            try {
                const response = await fetchWithTimeout(getProxyUrl(`/search/issues?q=author:${username}+type:pr+state:all&per_page=1`));
                if (!response.ok) throw new Error();
                const data = await response.json();
                return data.total_count || 0;
            } catch (err) {
                return 0;
            }
        }

        // 5.4 获取Issues总数
        async function fetchIssuesData(username) {
            try {
                const response = await fetchWithTimeout(getProxyUrl(`/search/issues?q=author:${username}+type:issue+state:all&per_page=1`));
                if (!response.ok) throw new Error();
                const data = await response.json();
                return data.total_count || 0;
            } catch (err) {
                return 0;
            }
        }

        // 5.5 获取贡献仓库数
        async function fetchContributedRepos(username) {
            try {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const sinceDate = oneYearAgo.toISOString().split('T')[0];
                const response = await fetchWithTimeout(getProxyUrl(`/users/${username}/events?per_page=300&since=${sinceDate}`));
                if (!response.ok) throw new Error();
                const events = await response.json();
                const repos = new Set();
                events.forEach(event => {
                    if (event.repo && !['WatchEvent', 'ForkEvent'].includes(event.type)) {
                        repos.add(event.repo.name);
                    }
                });
                return repos.size;
            } catch (err) {
                return 0;
            }
        }

        // 6. 渲染用户信息
        function renderUserData(userData) {
            userAvatar.src = userData.avatar_url;
            userAvatar.alt = `${userData.login}'s Avatar`;
            userUrl.textContent = `@${userData.login}`;
            userUrl.href = userData.html_url;
        }

        // 7. 渲染统计数据
        function renderStatsData(statsData) {
            document.getElementById('stars-count').textContent = formatNumber(statsData.stars);
            document.getElementById('commits-count').textContent = formatNumber(statsData.commits);
            document.getElementById('prs-count').textContent = formatNumber(statsData.prs);
            document.getElementById('issues-count').textContent = formatNumber(statsData.issues);
            document.getElementById('contrib-count').textContent = formatNumber(statsData.contributions);
        }

        // 8. 计算并渲染学术等级
        function calculateAndRenderRank(statsData) {
            const { commits, stars, prs, issues, contributions } = statsData;
            const getStandardScore = (value, max) => Math.min(Math.round((value / max) * 100), 100);
            
            const scores = {
                commits: getStandardScore(commits, 1000),
                stars: getStandardScore(stars, 100),
                prs: getStandardScore(prs, 50),
                issues: getStandardScore(issues, 50),
                contributions: getStandardScore(contributions, 20)
            };

            const totalScore = 
                scores.commits * 0.4 + 
                scores.stars * 0.2 + 
                scores.prs * 0.2 + 
                scores.issues * 0.1 + 
                scores.contributions * 0.1;

            // 等级映射
            let rank = 'D';
            if (totalScore >= 95) rank = 'S+';
            else if (totalScore >= 90) rank = 'S';
            else if (totalScore >= 85) rank = 'A+';
            else if (totalScore >= 80) rank = 'A';
            else if (totalScore >= 70) rank = 'B+';
            else if (totalScore >= 60) rank = 'B';
            else if (totalScore >= 50) rank = 'C+';
            else if (totalScore >= 40) rank = 'C';
            else if (totalScore >= 30) rank = 'C-';
            else rank = 'D';

            rankText.textContent = rank;
            const progress = (totalScore / 100) * CIRCUMFERENCE;
            rankCircle.style.strokeDasharray = CIRCUMFERENCE;
            rankCircle.style.strokeDashoffset = CIRCUMFERENCE - progress;
        }

        // 9. 数字格式化工具
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toString();
        }

        // 10. 显示错误信息
        function showError(message) {
            loading.style.display = 'none';
            error.style.display = 'flex';
            error.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> ${message}`;
            statsCard.style.display = 'none';
        }

        // 11. 显示卡片
        function showCard() {
            loading.style.display = 'none';
            error.style.display = 'none';
            statsCard.style.display = 'flex';
        }

        // 核心逻辑：页面加载时自动执行
        async function init() {
            const username = getUsernameFromUrl();
            
            // 无username参数时提示
            if (!username) {
                showError('请在URL后添加参数：?username=你的GitHub用户名（例：?username=welives）');
                return;
            }

            try {
                // 并行请求数据
                const [userData, statsData] = await Promise.all([
                    fetchUserData(username),
                    fetchAllStatsData(username)
                ]);

                // 渲染卡片
                renderUserData(userData);
                renderStatsData(statsData);
                calculateAndRenderRank(statsData);
                showCard();
            } catch (err) {
                // 错误处理
                const errorMsg = err.name === 'AbortError' ? '请求超时，请检查网络或稍后重试' :
                                 err.message.includes('404') ? 'GitHub用户名不存在' :
                                 '获取数据失败：' + err.message;
                showError(errorMsg);
            }
        }

        // 页面加载完成后初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>